<project name="slice2cpp">
  <target name="check-file">
    <available file="src/main/slice" property="fileExists"/>
  </target>

  <target name="slice2cpp" depends="check-file" if="fileExists">
    <antcall target="create-folder"/>
    <exec executable="bash" failonerror="true">
      <arg line="-c 'target/nar/ice-exec-${ice.version}-${nar.aol}-executable/bin/${nar.aol}/slice2cpp --dll-export ${project.artifactId}_api src/main/slice/*.slice.ice ; /bin/sed -i &quot;s/_api_EXPORTS/_exports/g&quot; *.slice.h'"/>
      <env key="LD_LIBRARY_PATH" value="target/nar/Ice-${ice.version}-${nar.aol}-shared/lib/${nar.aol}/shared:target/nar/IceUtil-${ice.version}-${nar.aol}-shared/lib/${nar.aol}/shared:${env.LD_LIBRARY_PATH}"/>
      <env key="PATH" value="target/nar/ice-${ice.version}-${nar.aol}-shared/lib/${nar.aol}/shared;target/nar/iceutil-${ice.version}-${nar.aol}-shared/lib/${nar.aol}/shared"/>
    </exec>
    <antcall target="disable-warning"/>
    <antcall target="move-file"/>
  </target>

  <target name="create-folder">
    <mkdir dir="src/main/include"/>
    <mkdir dir="src/main/c"/>
  </target>
  <target name="disable-warning">
    <tempfile property="sed.temp" prefix="warning." deleteonexit="true"></tempfile>
    <echo file="${sed.temp}" append="false">sed -i '1i#pragma warning( disable: 4267 4800 4996 )' *.slice.*
sed -i '1i#pragma warning( push )' *.slice.*
sed -i '$a#pragma warning( pop )' *.slice.*</echo>
    <exec executable="bash" failonerror="true">
      <arg line="${sed.temp}"/>
    </exec>
  </target>
  <target name="move-file">
    <exec executable="bash" failonerror="true">
      <arg line="-c '/bin/mv *.slice.cpp src/main/c; /bin/mv *.slice.h src/main/include'"/>
    </exec>
  </target>
</project>